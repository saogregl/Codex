datasource db {
  provider = "sqlite"
  url      = "file:dev.db"
}

generator client {
  provider    = "cargo prisma"
  output      = "../../crates/prisma/src/prisma.rs"
  module_path = "codex_prisma::prisma"
}

model User {
  id          String @id
  displayName String
}

/// @shared(id: pub_id)
model FilePath {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(uuid())

  is_dir Boolean?

  // the name and extension, MUST have 'COLLATE NOCASE' in migration
  name      String?
  extension String?

  path_relative_to_location String?

  size_in_bytes_bytes Bytes?

  // the unique Object for this file path
  Object_id Int?    @unique
  Object    Object? @relation(fields: [Object_id], references: [id], onDelete: SetNull)

  date_created  DateTime?
  date_modified DateTime?
  date_indexed  DateTime?

  @@map("file_path")
}

/// @shared(id: pub_id)
model Object {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(uuid())

  obj_name String?
  // Enum: sd_file_ext::kind::ObjectKind
  kind     Int?

  // handy ways to mark an Object
  hidden        Boolean?
  favorite      Boolean?
  important     Boolean?
  note          String?
  date_created  DateTime? @default(now())
  date_accessed DateTime?

  tags      TagOnObject[]
  labels    LabelOnObject[]
  file_path FilePath?
  Library   Library?        @relation(fields: [libraryId], references: [id])
  libraryId Int?

  @@map("Object")
}

model Location {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(uuid())

  name                   String?
  path                   String
  total_capacity         Int?
  available_capacity     Int?
  is_archived            Boolean?
  generate_preview_media Boolean?
  hidden                 Boolean?
  date_created           DateTime?

  instance_id Int?
  Library     Library? @relation(fields: [libraryId], references: [id])
  libraryId   Int?

  // instance    Instance? @relation(fields: [instance_id], references: [id]) // TODO: Enabling this breaks migration 7's `update_many` in `library/config.rs`
  @@map("location")
}

model Library {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  name            String?
  // Enum: ???
  redundancy_goal Int?
  date_created    DateTime?
  date_modified   DateTime?

  // the library can contain multiple locations. 
  locations Location[]

  Objects Object[]

  @@map("library")
}

//// Tag ////

/// @shared(id: pub_id)
model Tag {
  id              Int           @id @default(autoincrement())
  pub_id          Bytes         @unique
  name            String?
  color           String?
  // Enum: ??
  redundancy_goal Int?
  date_created    DateTime?
  date_modified   DateTime?
  tag_Objects     TagOnObject[]

  @@map("tag")
}

/// @relation(item: tag, group: Object)
model TagOnObject {
  tag_id    Int
  tag       Tag    @relation(fields: [tag_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Object_id Int
  Object    Object @relation(fields: [Object_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([tag_id, Object_id])
  @@map("tag_on_Object")
}

//// Label ////

model Label {
  id            Int             @id @default(autoincrement())
  pub_id        Bytes           @unique
  name          String?
  date_created  DateTime        @default(now())
  date_modified DateTime        @default(now())
  label_Objects LabelOnObject[]

  @@map("label")
}

model LabelOnObject {
  date_created DateTime @default(now())
  label_id     Int
  label        Label    @relation(fields: [label_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Object_id    Int
  Object       Object   @relation(fields: [Object_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([label_id, Object_id])
  @@map("label_on_Object")
}
